import React, { Component } from 'react';
import logo from './logo.svg';
import './App.css';
import { default as Web3 } from 'web3';


class App extends Component {
  constructor(props) {
    super(props);
    this.state = {
      symtomps: "",
      diagnosis: "",
      treatment: "",
      count: null,
      patientCode: "0x608060405234801561001057600080fd5b50600080819055506112d1806100276000396000f300608060405260043610610083576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806303e9e6091461008857806306661abd146100c75780634a748dc5146100f25780637564a13c1461011f578063942b765a1461015e5780639841c82c14610189578063b8647788146101b2575b600080fd5b34801561009457600080fd5b506100af60048036036100aa9190810190610f57565b6101df565b6040516100be939291906110e9565b60405180910390f35b3480156100d357600080fd5b506100dc610425565b6040516100e99190611181565b60405180910390f35b3480156100fe57600080fd5b5061010761042b565b604051610116939291906110e9565b60405180910390f35b34801561012b57600080fd5b5061014660048036036101419190810190610f57565b610672565b60405161015593929190611135565b60405180910390f35b34801561016a57600080fd5b50610173610873565b60405161018091906110c7565b60405180910390f35b34801561019557600080fd5b506101b060048036036101ab9190810190610ec0565b610ab9565b005b3480156101be57600080fd5b506101c7610b61565b6040516101d6939291906110e9565b60405180910390f35b60608060606001848154811015156101f357fe5b906000526020600020906003020160000160018581548110151561021357fe5b906000526020600020906003020160010160018681548110151561023357fe5b9060005260206000209060030201600201828054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102d95780601f106102ae576101008083540402835291602001916102d9565b820191906000526020600020905b8154815290600101906020018083116102bc57829003601f168201915b50505050509250818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156103755780601f1061034a57610100808354040283529160200191610375565b820191906000526020600020905b81548152906001019060200180831161035857829003601f168201915b50505050509150808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104115780601f106103e657610100808354040283529160200191610411565b820191906000526020600020905b8154815290600101906020018083116103f457829003601f168201915b505050505090509250925092509193909250565b60005481565b60608060606001600081548110151561044057fe5b90600052602060002090600302016000016001600081548110151561046157fe5b90600052602060002090600302016001016001600081548110151561048257fe5b9060005260206000209060030201600201828054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156105285780601f106104fd57610100808354040283529160200191610528565b820191906000526020600020905b81548152906001019060200180831161050b57829003601f168201915b50505050509250818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156105c45780601f10610599576101008083540402835291602001916105c4565b820191906000526020600020905b8154815290600101906020018083116105a757829003601f168201915b50505050509150808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106605780601f1061063557610100808354040283529160200191610660565b820191906000526020600020905b81548152906001019060200180831161064357829003601f168201915b50505050509050925092509250909192565b60018181548110151561068157fe5b9060005260206000209060030201600091509050806000018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561072d5780601f106107025761010080835404028352916020019161072d565b820191906000526020600020905b81548152906001019060200180831161071057829003601f168201915b505050505090806001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107cb5780601f106107a0576101008083540402835291602001916107cb565b820191906000526020600020905b8154815290600101906020018083116107ae57829003601f168201915b505050505090806002018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108695780601f1061083e57610100808354040283529160200191610869565b820191906000526020600020905b81548152906001019060200180831161084c57829003601f168201915b5050505050905083565b60606001805480602002602001604051908101604052809291908181526020016000905b82821015610ab0578382906000526020600020906003020160606040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109545780601f1061092957610100808354040283529160200191610954565b820191906000526020600020905b81548152906001019060200180831161093757829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156109f65780601f106109cb576101008083540402835291602001916109f6565b820191906000526020600020905b8154815290600101906020018083116109d957829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610a985780601f10610a6d57610100808354040283529160200191610a98565b820191906000526020600020905b815481529060010190602001808311610a7b57829003601f168201915b50505050508152505081526020019060010190610897565b50505050905090565b600160606040519081016040528085815260200184815260200183815250908060018154018082558091505090600182039060005260206000209060030201600090919290919091506000820151816000019080519060200190610b1e929190610db1565b506020820151816001019080519060200190610b3b929190610db1565b506040820151816002019080519060200190610b58929190610db1565b50505050505050565b606080606060018060005403815481101515610b7957fe5b906000526020600020906003020160000160018060005403815481101515610b9d57fe5b906000526020600020906003020160010160018060005403815481101515610bc157fe5b9060005260206000209060030201600201828054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c675780601f10610c3c57610100808354040283529160200191610c67565b820191906000526020600020905b815481529060010190602001808311610c4a57829003601f168201915b50505050509250818054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d035780601f10610cd857610100808354040283529160200191610d03565b820191906000526020600020905b815481529060010190602001808311610ce657829003601f168201915b50505050509150808054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610d9f5780601f10610d7457610100808354040283529160200191610d9f565b820191906000526020600020905b815481529060010190602001808311610d8257829003601f168201915b50505050509050925092509250909192565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610df257805160ff1916838001178555610e20565b82800160010185558215610e20579182015b82811115610e1f578251825591602001919060010190610e04565b5b509050610e2d9190610e31565b5090565b610e5391905b80821115610e4f576000816000905550600101610e37565b5090565b90565b600082601f8301121515610e6957600080fd5b8135610e7c610e77826111c9565b61119c565b91508082526020830160208301858383011115610e9857600080fd5b610ea3838284611244565b50505092915050565b6000610eb8823561123a565b905092915050565b600080600060608486031215610ed557600080fd5b600084013567ffffffffffffffff811115610eef57600080fd5b610efb86828701610e56565b935050602084013567ffffffffffffffff811115610f1857600080fd5b610f2486828701610e56565b925050604084013567ffffffffffffffff811115610f4157600080fd5b610f4d86828701610e56565b9150509250925092565b600060208284031215610f6957600080fd5b6000610f7784828501610eac565b91505092915050565b6000610f8b82611202565b80845260208401935083602082028501610fa4856111f5565b60005b84811015610fdd578383038852610fbf83835161105a565b9250610fca82611223565b9150602088019750600181019050610fa7565b508196508694505050505092915050565b6000610ff982611218565b80845261100d816020860160208601611253565b61101681611286565b602085010191505092915050565b600061102f8261120d565b808452611043816020860160208601611253565b61104c81611286565b602085010191505092915050565b600060608301600083015184820360008601526110778282611024565b915050602083015184820360208601526110918282611024565b915050604083015184820360408601526110ab8282611024565b9150508091505092915050565b6110c181611230565b82525050565b600060208201905081810360008301526110e18184610f80565b905092915050565b600060608201905081810360008301526111038186610fee565b905081810360208301526111178185610fee565b9050818103604083015261112b8184610fee565b9050949350505050565b6000606082019050818103600083015261114f8186611024565b905081810360208301526111638185611024565b905081810360408301526111778184611024565b9050949350505050565b600060208201905061119660008301846110b8565b92915050565b6000604051905081810181811067ffffffffffffffff821117156111bf57600080fd5b8060405250919050565b600067ffffffffffffffff8211156111e057600080fd5b601f19601f8301169050602081019050919050565b6000602082019050919050565b600081519050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000819050919050565b6000819050919050565b82818337600083830152505050565b60005b83811015611271578082015181840152602081019050611256565b83811115611280576000848401525b50505050565b6000601f19601f83011690509190505600a265627a7a72305820edc2087e0b150c5469ece52c1cedf16366b98c797f062fcf5f04978e8e37d1c16c6578706572696d656e74616cf50037",
      patientContract: window.web3.eth.contract([
        {
          "constant": false,
          "inputs": [
            {
              "name": "symptoms",
              "type": "string"
            },
            {
              "name": "diagnosis",
              "type": "string"
            },
            {
              "name": "treatment",
              "type": "string"
            }
          ],
          "name": "createProfile",
          "outputs": [],
          "payable": false,
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [],
          "payable": false,
          "stateMutability": "nonpayable",
          "type": "constructor"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "count",
          "outputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "getLatestRecord",
          "outputs": [
            {
              "name": "",
              "type": "string"
            },
            {
              "name": "",
              "type": "string"
            },
            {
              "name": "",
              "type": "string"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "getList",
          "outputs": [
            {
              "components": [
                {
                  "name": "symptoms",
                  "type": "string"
                },
                {
                  "name": "diagnosis",
                  "type": "string"
                },
                {
                  "name": "treatment",
                  "type": "string"
                }
              ],
              "name": "",
              "type": "tuple[]"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [],
          "name": "getOriginRecord",
          "outputs": [
            {
              "name": "",
              "type": "string"
            },
            {
              "name": "",
              "type": "string"
            },
            {
              "name": "",
              "type": "string"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [
            {
              "name": "index",
              "type": "uint256"
            }
          ],
          "name": "getRecord",
          "outputs": [
            {
              "name": "",
              "type": "string"
            },
            {
              "name": "",
              "type": "string"
            },
            {
              "name": "",
              "type": "string"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        },
        {
          "constant": true,
          "inputs": [
            {
              "name": "",
              "type": "uint256"
            }
          ],
          "name": "medicalRecords",
          "outputs": [
            {
              "name": "symptoms",
              "type": "string"
            },
            {
              "name": "diagnosis",
              "type": "string"
            },
            {
              "name": "treatment",
              "type": "string"
            }
          ],
          "payable": false,
          "stateMutability": "view",
          "type": "function"
        }
      ]),
      patientContractInstance: null,
      account: ""
    }
    this.createContract = this.createContract.bind(this);
    this.handleNameChange = this.handleNameChange.bind(this);
    this.handleAgeChange = this.handleAgeChange.bind(this);
    this.handleSymtompsChange = this.handleSymtompsChange.bind(this);
    this.handleTreatmentChange = this.handleTreatmentChange.bind(this);
    this.handleDiagnosisChange = this.handleDiagnosisChange.bind(this);
    this.handleRecordCountChange = this.handleRecordCountChange.bind(this);
  }

  updateAccount = (accs) => {
    this.setState({ account: accs[0]});
    window.web3.eth.defaultAccount = this.state.account;
  }


  componentDidMount() {
   
     window.web3.eth.getAccounts((err, accs) => {
      if (err != null) {
        alert("There was an error fetching your accounts.");
        return;
      }

      if (accs.length == 0) {
        alert("Couldn't get any accounts! Make sure your Ethereum client is configured correctly.");
        return;
      }
      this.updateAccount(accs)

    });
  
  }

  handleNameChange (event) {
    this.setState ({ name: event.target.value});
  }

  handleAgeChange (event) {
    this.setState ({ age: event.target.value});
  }

  handleSymtompsChange (event) {
    this.setState ({ symtomps: event.target.value});
  }

  handleTreatmentChange (event) {
    this.setState ({ treatment: event.target.value});
  }

  handleDiagnosisChange (event) {
    this.setState ({ diagnosis: event.target.value});
  }

  handleRecordCountChange (event) {
    this.setState ({ count: event.target.value});
  }

 
  createContract() {
    // var message = document.getElementById('message');
    // message.innerText = 'attempting new contract...';
    var patient = this.state.patientContract.new(
      {
        from: this.state.account,
        data: this.state.patientCode,
        gas: '4700000'
      }, function (e, contract) {
        console.log(e, contract);
        if (typeof contract.address !== 'undefined') {
          console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);
          document.getElementById('contractAddress').value = contract.address;
        }
      })
  };


  addNewRecord = () => {

    var contractAddress = document.getElementById('contractAddress').value.toString();
    var deployedPatient = this.state.patientContract.at(contractAddress);

    deployedPatient.createProfile(this.state.symtomps, this.state.diagnosis, this.state.treatment, function (error,result) {
      if (error) {
        console.error(error);
        return;
      }
      console.log("Result is: ", result);
    });
  }

  getMedicalRecord = () => {

    var contractAddress = document.getElementById('contractAddress').value.toString();
    var deployedPatient = this.state.patientContract.at(contractAddress);

    deployedPatient.getRecord(this.state.count, function (error,result) {
      if (error) {
        console.error(error);
        return;
      }
      console.log("Result is: ", result);
    });
  }

  getLatestMedicalRecord = () => {

    var contractAddress = document.getElementById('contractAddress').value.toString();
    var deployedPatient = this.state.patientContract.at(contractAddress);

    deployedPatient.getLatestRecord(function (error,result) {
      if (error) {
        console.error(error);
        return;
      }
      console.log("Result is: ", result);
    });
  }

  getListofRecord = () => {
    var contractAddress = document.getElementById('contractAddress').value.toString();
    var deployedPatient = this.state.patientContract.at(contractAddress);

    deployedPatient.getList(function (error,result) {
      if (error) {
        console.error(error);
        return;
      }
      console.log("Result is: ", window.web3.toAscii(result));
    });

  }

  render() {
    return (
      <div className="App">
        <header className="App-header">
          <img src={logo} className="App-logo" alt="logo" />
          <h1 className="App-title">Welcome to React</h1>
        </header>
        <br /> <label htmlFor="contractAddress">Contract Address:</label> <input type="text" id="contractAddress" placeholder="Scan address or create a new contract"></input>
        <br />
        <br />
        <br />
        <button onClick={this.createContract}> Create new Patient </button>
        <br/>
        <br/>
        <form>
          <input 
            type="text" 
            name="symtomps" 
            placeholder="Enter new symtomps ..."
            value={this.state.symtomps}
            onChange={ this.handleSymtompsChange }/>
          <input 
            type="text" 
            name="diagnosis" 
            placeholder="Enter new diagnosis ..."
            value={this.state.diagnosis}
            onChange={ this.handleDiagnosisChange }/>
          <input 
            type="text" 
            name="treatment" 
            placeholder="Enter new treatment ..."
            value={this.state.treatment}
            onChange={ this.handleTreatmentChange }/>
        </form>
        <button onClick={this.addNewRecord}> Add new record ... </button>
        <form>
          <input 
            type="text" 
            name="count"
            onChange={ this.handleRecordCountChange }/>
        </form>
        <button onClick={this.getMedicalRecord}> Get record ... </button>
        <button onClick={this.getLatestMedicalRecord}> Get latest record ... </button>
        <button onClick={this.getListofRecord}> Get list record ... </button>
      </div>
    );
  }
}

export default App;
